name: Run Python Script For bdt

on:
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:

      - name: Check time in Japan (before setup)
        run: |
          # 获取日本时间小时
          HOUR=$(TZ='Asia/Tokyo' date +%H)
          echo "現在の日本時間: ${HOUR}時"

          # 判断是否在6:00~次日3:00之间
          if [ "$HOUR" -ge 3 ] && [ "$HOUR" -lt 6 ]; then
            echo "現在は実行時間外（3～6時）。ジョブを終了します。"
            exit 0
          fi

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install selenium

      - name: Install jpholiday
        run: |
          pip install beautifulsoup4
          pip install jpholiday

      - name: Run script      
        env:
          TARGET_LINK: ${{ secrets.TARGET_LINK }}
          EMAIL_FROM:  ${{ secrets.EMAIL_FROM }}
          EMAIL_TO:    ${{ secrets.EMAIL_TO }}
          EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
        run: python main.pyw

      - name: Commit txt file to repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
      
          # 添加 .gitignore（如果存在）
          if [ -f .gitignore ]; then
            git add .gitignore
          fi
      
          # 添加所有 txt 文件的新增/删除
          git add -A output
      
          # 判断是否有变更
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update result files"
            git pull --rebase
            git push
          else
            echo "📭 没有变更需要提交，跳过 commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
