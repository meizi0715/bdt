name: Run Python Script For bdt

on:
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:

      - name: Check time in Japan (before setup)
        run: |
          # è·å–æ—¥æœ¬æ—¶é—´å°æ—¶
          HOUR=$(TZ='Asia/Tokyo' date +%H)
          echo "ç¾åœ¨ã®æ—¥æœ¬æ™‚é–“: ${HOUR}æ™‚"

          # åˆ¤æ–­æ˜¯å¦åœ¨6:00~æ¬¡æ—¥3:00ä¹‹é—´
          if [ "$HOUR" -ge 3 ] && [ "$HOUR" -lt 6 ]; then
            echo "ç¾åœ¨ã¯å®Ÿè¡Œæ™‚é–“å¤–ï¼ˆ3ï½6æ™‚ï¼‰ã€‚ã‚¸ãƒ§ãƒ–ã‚’çµ‚äº†ã—ã¾ã™ã€‚"
            exit 0
          fi

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install selenium

      - name: Install jpholiday
        run: |
          pip install beautifulsoup4
          pip install jpholiday

      - name: Run script      
        env:
          TARGET_LINK: ${{ secrets.TARGET_LINK }}
          EMAIL_FROM:  ${{ secrets.EMAIL_FROM }}
          EMAIL_TO:    ${{ secrets.EMAIL_TO }}
          EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
        run: python main.pyw

      - name: Commit txt file to repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
      
          # æ·»åŠ  .gitignoreï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f .gitignore ]; then
            git add .gitignore
          fi
      
          # æ·»åŠ æ‰€æœ‰ txt æ–‡ä»¶çš„æ–°å¢/åˆ é™¤
          git add -A output
      
          # åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update result files"
            git pull --rebase
            git push
          else
            echo "ğŸ“­ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤ï¼Œè·³è¿‡ commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
